<div class="mb-4">
  <h2>Account: <%= @account.name %></h2>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <%= link_to "Accounts", accounts_path %>
      </li>
      <li class="breadcrumb-item">
        <%= link_to @account.name, @account %>
      </li>
      <li class="breadcrumb-item active" aria-current="page">License Assignments</li>
    </ol>
  </nav>
  
  <% if flash[:alert] %>
    <div class="alert alert-danger">
      <%= flash[:alert] %>
    </div>
  <% end %>
</div>

<div data-controller="license-assignment">
  <%= form_with url: account_license_assignments_path(@account), turbo_method: :post, local: true do |form| %>
    <div class="row">
      <div class="col-md-5">
        <div class="card">
          <div class="card-header">
            <h5>Product Licenses</h5>
          </div>
          <div class="card-body overflow-auto" style="max-height: 400px; overflow-y: auto;">
            <% if @products_with_licenses.any? %>
              <% @products_with_licenses.each do |product_data| %>
                <div class="form-check mb-3">
                  <%= check_box_tag "product_ids[]", product_data[:product].id, false, 
                                   class: "form-check-input", 
                                   id: "product_#{product_data[:product].id}",
                                   data: { license_assignment_target: "productCheckbox" } %>
                  <%= label_tag "product_#{product_data[:product].id}", class: "form-check-label" do %>
                    <strong><%= product_data[:product].name %></strong>
                    (<%= product_data[:used_licenses] %>/<%= product_data[:total_licenses] %>)
                    <% if product_data[:available_licenses] == 0 %>
                      <span class="badge bg-warning text-dark">Full</span>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <p class="text-muted">No active subscriptions for this account.</p>
            <% end %>
          </div>
        </div>
      </div>
      
      <div class="col-md-2 text-center d-flex flex-column justify-content-center">
        <% if @products_with_licenses.any? && @users.any? %>
          <%= form.submit "Assign", class: "btn btn-success mb-2" %>
          <button type="button" class="btn btn-warning" data-action="click->license-assignment#unassign">
            Unassign
          </button>
        <% else %>
          <p class="text-muted small">Need both users and active subscriptions to manage licenses.</p>
        <% end %>
      </div>
      
      <div class="col-md-5">
        <div class="card">
          <div class="card-header">
            <h5>Users</h5>
          </div>
          <div class="card-body overflow-auto" style="max-height: 400px; overflow-y: auto;">
            <% if @users.any? %>
              <% @users.each do |user| %>
                <div class="form-check mb-3">
                  <%= check_box_tag "user_ids[]", user.id, false, 
                                   class: "form-check-input", 
                                   id: "user_#{user.id}",
                                   data: { license_assignment_target: "userCheckbox" } %>
                  <%= label_tag "user_#{user.id}", class: "form-check-label" do %>
                    <strong><%= user.name %></strong><br>
                    <small class="text-muted"><%= user.email %></small>
                    <% if user.license_count > 0 %>
                      <br><span class="badge bg-info"><%= user.license_count %> licenses</span>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <p class="text-muted">No users in this account yet.</p>
              <%= link_to "Add Users", new_account_user_path(@account), class: "btn btn-primary btn-sm" %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <%= form_with url: bulk_destroy_account_license_assignments_path(@account), 
               turbo_method: :delete, local: true, style: "display: none;",
               data: { license_assignment_target: "unassignForm" } do |form| %>
  <% end %>
</div>

<div class="mt-5">
  <h3>Current License Assignments</h3>
  <% if @assigned_licenses.any? %>
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>User</th>
            <th>Product</th>
            <th>Assigned Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @assigned_licenses.each do |assignment| %>
            <tr>
              <td>
                <strong><%= assignment.user.name %></strong><br>
                <small class="text-muted"><%= assignment.user.email %></small>
              </td>
              <td><%= assignment.product.name %></td>
              <td><%= assignment.created_at.strftime("%B %d, %Y") %></td>
              <td>  
                <%= link_to "Remove",
                            account_license_assignment_path(@account, assignment),
                            data: { turbo_method: :delete, turbo_confirm: "Are you sure?" },
                            class: "btn btn-sm btn-outline-danger" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="text-center py-4">
      <p class="text-muted">No licenses assigned yet.</p>
      <% if @products_with_licenses.any? && @users.any? %>
        <p class="small">Select products and users above, then click "Assign" to get started.</p>
      <% end %>
    </div>
  <% end %>
</div>

<div class="mt-4">
  <%= link_to "Back to Account", @account, class: "btn btn-secondary" %>
</div>